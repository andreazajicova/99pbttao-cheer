{"version":3,"sources":["../src/app.js"],"names":["express","require","connectDB","mongoose","http","app","server","createServer","socket","io","cookieParser","path","GoogleStrategy","Strategy","passport","session","MongoStore","cors","sharedsession","User","passportSocketIo","config","use","json","static","join","__dirname","origin","credentials","sessionStore","mongooseConnection","connection","expressSession","secret","resave","saveUninitialized","store","initialize","rooms","users","autoSave","onAuthorizeSuccess","data","accept","console","log","onAuthorizeFail","message","error","Error","authorize","key","success","fail","on","packet","next","request","isAuthenticated","user","authLevel","emit","socketId","id","broadcast","find","x","userId","userID","userName","creator","push","_data","callback","undefined","from","to","target","signal","filter","room","caller","sockets","adapter","leave","get","req","res","sendFile","module","exports"],"mappings":"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","file":"app.js","sourcesContent":["const express = require('express');\nconst connectDB = require('../config/db.js');\nconst mongoose = require('mongoose');\nconst http = require('http');\nconst app = express();\nconst server = http.createServer(app);\nconst socket = require('socket.io');\nconst io = socket(server);\nconst cookieParser = require('cookie-parser');\nconst path = require('path');\nconst GoogleStrategy = require('passport-google-oauth20').Strategy;\nconst passport = require('passport');\nconst session = require('express-session');\nconst MongoStore = require('connect-mongo')(session);\nconst cors = require('cors');\nconst sharedsession = require('express-socket.io-session');\nconst User = require('../models/User');\nconst passportSocketIo = require('passport.socketio');\n\nrequire('dotenv').config({\n\tpath: './config/config.env',\n});\nrequire('../config/passport')(passport);\n\nconnectDB();\n\napp.use(cookieParser());\napp.use(express.json());\napp.use(express.static(path.join(__dirname, '../client/build')));\napp.use(\n\tcors({\n\t\torigin: 'http://localhost:3000',\n\t\tcredentials: true,\n\t})\n);\n\n// Sessions\nconst sessionStore = new MongoStore({\n\tmongooseConnection: mongoose.connection,\n});\nconst expressSession = session({\n\tsecret: 'keyboard puppy',\n\tresave: true,\n\tsaveUninitialized: true,\n\tstore: sessionStore,\n});\n\n// Passport middleware\napp.use(expressSession);\napp.use(passport.initialize());\napp.use(passport.session());\n\napp.use('/auth', require('../routes/auth'));\n\nlet rooms = [];\nlet users = [];\n\nio.use(\n\tsharedsession(expressSession, {\n\t\tautoSave: true,\n\t})\n);\n\nfunction onAuthorizeSuccess(data, accept) {\n\tconsole.log('successful connection to socket.io');\n\taccept();\n}\n\nfunction onAuthorizeFail(data, message, error, accept) {\n\tconsole.log('could not authorize');\n\tif (error) accept(new Error(message));\n}\n\nio.use(\n\tpassportSocketIo.authorize({\n\t\tkey: 'connect.sid',\n\t\tsecret: 'keyboard puppy',\n\t\tstore: sessionStore,\n\t\tpassport: passport,\n\t\tcookieParser: cookieParser,\n\t\tsuccess: onAuthorizeSuccess,\n\t\tfail: onAuthorizeFail,\n\t})\n);\n\nio.on('connection', socket => {\n\tsocket.use(async (packet, next) => {\n\t\tconsole.log('user is authenticated: ' + socket.request.isAuthenticated());\n\t\tif (socket.request.isAuthenticated()) {\n\t\t\tconsole.log('user has access level: ' + socket.request.user.authLevel);\n\t\t\tsocket.emit('accessLevel', {\n\t\t\t\tauthLevel: socket.request.user.authLevel,\n\t\t\t\tsocketId: socket.id,\n\t\t\t});\n\t\t\treturn next();\n\t\t}\n\t});\n\n\tsocket.emit('yourId', socket.id);\n\n\tsocket.emit('newUser', users);\n\tsocket.broadcast.emit('newUser', users);\n\n\tsocket.on('createRoom', data => {\n\t\tif (socket.request.user.authLevel === 'admin') {\n\t\t\tif (!users.find(x => x.userId === data.userID)) {\n\t\t\t\tusers = [\n\t\t\t\t\t...users,\n\t\t\t\t\t{\n\t\t\t\t\t\tid: data.socketId,\n\t\t\t\t\t\tuserId: data.userID,\n\t\t\t\t\t\tuserName: data.creator,\n\t\t\t\t\t\tauthLevel: data.authLevel,\n\t\t\t\t\t},\n\t\t\t\t];\n\t\t\t}\n\t\t\trooms.push(data);\n\t\t\tsocket.emit('users', users);\n\t\t\tsocket.broadcast.emit('users', users);\n\t\t}\n\t});\n\n\tsocket.on('getUsers', (_data, callback) => {\n\t\tconsole.log('received call');\n\t\tcallback(undefined, users);\n\t});\n\n\tsocket.on('offer', data => {\n\t\tconsole.log('offer from: ' + data.from);\n\t\tio.to(data.target).emit('incomingCall', {\n\t\t\tfrom: data.from,\n\t\t\tsignal: data.signal,\n\t\t});\n\t});\n\n\tsocket.on('close', () => {\n\t\tusers = users.filter(user => user.id !== socket.id);\n\t\tsocket.emit('users', users);\n\t});\n\n\tsocket.on('endCall', data => {\n\t\tlet room;\n\t\tif (data.caller) {\n\t\t\troom = io.sockets.adapter.rooms[data.caller];\n\t\t} else {\n\t\t\troom = io.sockets.adapter.rooms[data.userId];\n\t\t}\n\t\tsocket.leave(room);\n\t});\n\n\tsocket.on('disconnect', () => {\n\t\tusers = users.filter(user => user.id !== socket.id);\n\t\tsocket.broadcast.emit('users', users);\n\t});\n\n\tsocket.on('answer', data => {\n\t\tconst room = io.sockets.adapter.rooms[data.target];\n\t\tconsole.log('answer to join: ' + data.target);\n\t\tsocket.join(data.target);\n\t\tio.to(data.target).emit('acceptedCall', { signal: data.signal });\n\t});\n});\n\napp.get('*', (req, res) => {\n\tres.sendFile(path.join(__dirname, '../client/build/index.html'));\n});\n\nmodule.exports = { app, server, expressSession };\n"]}